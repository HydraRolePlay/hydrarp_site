<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="icon" href="{{img}}logo.png" sizes="16x16">
    <title>HydraRP</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{css}}changer.css">
</head>
<body>
    <div class="block">
        <div class="block__body">
            <div class="block__content">
                <div class="block__header">Изменение пароля</div>
                <div class="block__msg"></div>
                <form action="" class="block__form block__form_1" style="display: flex;">
                    <p>Введите Логин / E-mail аккаута</p>
                    <input type="text" name="login" placeholder="Логин / E-mail">
                    <div class="group">
                        <a href="/" class="block__back block__back_1">Отмена</a>
                        <div class="block__submit block__submit_1">Продолжить</div>
                    </div>
                </form>
                <form action="" class="block__form block__form_2" style="display: none;">
                    <p>Введите код, который пришел Вам на почту</p>
                    <input type="text" name="code" placeholder="Код">
                    <div class="group">
                        <div class="block__back block__back_2">Назад</div>
                        <div class="block__submit block__submit_2">Продолжить</div>
                    </div>
                </form>
                <form action="" class="block__form block__form_3" style="display: none;">
                    <p>Введите новый пароль</p>
                    <input type="password" name="password1" placeholder="Пароль">
                    <input type="password" name="password2" placeholder="Повторите пароль">
                    <div class="group">
                        <a href="/" class="block__back block__back_3">Отмена</a>
                        <div class="block__submit block__submit_3">Сменить пароль</div>
                    </div>
                </form>
                <div class="block__success" style="display: none;">
                    <a href="/" class="block__back block__back_4">Вернуться на главную</a>
                </div>
            </div>
        </div>
    </div>
    <!-- JQ -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <style>
        @keyframes loading {
            20% {
                background: #355CFF;
            }
            50% {
                background: #A116E7;
            }
            70% {
                background: #A116E7;
            }
            100% {
                background: #355CFF;
            }
        }
        
        .loading_msg {
            animation: loading 3s ease alternate infinite;
        }
    </style>

    <script>
        function toggleAnimation() {
            $('.block__msg').text('');
            $('.block__msg').toggleClass('loading_msg');
        }

        function toggleBlock(id) {
            var blocks = $('.block__form, .block__success');
            for (var i = 0; i < 4; i++) {
                if (i != id) {
                    blocks[i].style.display = 'none';
                } else {
                    blocks[i].style.display = 'flex';
                }
            }
        }

        // submit_1
        $('.block__submit_1').on('click', function() {
            // toggleAnimation
            toggleAnimation();
            // condition
            if ($('.block__form_1>input').val().trim() != '') {
                // ajax
                $.ajax({
                    url:        '/handlechangepassword',
                    type:       'POST',
                    data:       $('.block__form_1').serialize(),
                    success:    function(response) {
                        // toggleAnimation
                        toggleAnimation();
                        // condition
                        var result = JSON.parse(response);
                        if (result['state'] === 'checking') {
                            $('.block__msg')[0].style.color = '#999999';
                            toggleBlock(1);
                        } else if (result['state'] === 'error') {
                            $('.block__msg')[0].style.color = 'red';
                        } else {
                            // ...
                        }
                        $('.block__msg').text(result['msg']);
                    },
                    error:      function(response, exception) {
                        alert("Простите, возникла ошибка на стороне сервера. Попробуйте еще раз.");
                    },
                });
            } else {
                toggleAnimation();
                $('.block__msg')[0].style.color = 'red';
                $('.block__msg').text('Заполните поле');
            }
        });

        // back_2
        $('.block__back_2').on('click', function() {
            toggleBlock(0);
        });

        // submit_2
        $('.block__submit_2').on('click', function() {
            toggleAnimation();
            if ($('.block__form_1>input').val().trim() != '' &&
                $('.block__form_2>input').val().trim() != '') {
                // ajax
                $.ajax({
                    url:        '/handlechangepassword',
                    type:       'POST',
                    data:       $('.block__form_1').serialize() + '&' + $('.block__form_2').serialize(),
                    success:    function(response) {
                        // toggleAnimation
                        toggleAnimation();
                        // condition
                        var result = JSON.parse(response);
                        if (result['state'] === 'changing') {
                            $('.block__msg')[0].style.color = '#999999';
                            toggleBlock(2);
                        } else if (result['state'] === 'error') {
                            $('.block__msg')[0].style.color = 'red';
                        } else {
                            // ...
                        }
                        $('.block__msg').text(result['msg']);
                    },
                    error:      function(response, exception) {
                        alert("Простите, возникла ошибка на стороне сервера. Попробуйте еще раз.");
                    },
                });
            } else {
                toggleAnimation();
                $('.block__msg')[0].style.color = 'red';
                $('.block__msg').text('Заполните поле');
            }
        });

        // submit_3
        $('.block__submit_3').on('click', function() {
            toggleAnimation();
            if ($('.block__form_1>input').val().trim() != '' &&
                $('.block__form_2>input').val().trim() != '' &&
                $('.block__form_3>input').val().trim() != '') {
                // ajax
                $.ajax({
                    url:        '/handlechangepassword',
                    type:       'POST',
                    data:       $('.block__form_1').serialize() + '&' + $('.block__form_2').serialize() + '&' + $('.block__form_3').serialize(),
                    success:    function(response) {
                        // toggleAnimation
                        toggleAnimation();
                        // condition
                        var result = JSON.parse(response);
                        if (result['state'] === 'success') {
                            $('.block__msg')[0].style.color = '#999999';
                            toggleBlock(3);
                        } else if (result['state'] === 'error') {
                            $('.block__msg')[0].style.color = 'red';
                        } else {
                            // ...
                        }
                        $('.block__msg').text(result['msg']);
                    },
                    error:      function(response, exception) {
                        alert("Простите, возникла ошибка на стороне сервера. Попробуйте еще раз.");
                    },
                });
            } else {
                toggleAnimation();
                $('.block__msg')[0].style.color = 'red';
                $('.block__msg').text('Заполните поля');
            }
        });
    </script>
</body>
</html>